# OONI Data formats

The output of test is the composition of:

    +---------------------------+
    |   Base data format        |
    +---------------------------+
    | Test template data format |
    +---------------------------+
    | Test specific data format |
    +---------------------------+

This document describes the base data format. A test template is a code
routine that performs functionality common across several OONI tests (also
known as nettests or experiments in more modern OONI lingo). Most OONI
nettests are based on test templates, therefore, the results often time
contain a data format depending on the used template.

In this directory shall go only the data format specifications of test
templates. The test specific data formats should go in the specification of the
test.

Data produced by the ooniprobe client is in JSON format.

# Base test data format

This specification is of the basic data format common to all ooniprobe test
outputs.

Every entry contains the following common fields. The `test_keys` key will
contain instead all the keys that are specific to the test in question, as well
as all the keys generated by the test template.

Keys starting with `x_` are always permitted anywhere. They are
experimental and should not be relied upon in the long term.

As an historical note, the `test_keys.resolver_ip` key has been set by
Measurement Kit implementations inside of the `test_keys` even though it
should have been part of the top-level keys. We have fixed this issue
with `data_format_version >= 0.2.1`. The first OONI Probe CLI release to
adopt this functionality has been `v3.0.0`. The first OONI Probe Mobile
version to adopt this functionality will be the one that switches from
Measurement Kit to `github.com/ooni/probe-engine`.

The JSON data format is made up of a series of JSON documents separated by
newline characters, also known as [JSONL](http://jsonlines.org/).

Data Format Version: 0.2.1

## Specification

The following fields are defined:

- `annotations` (`map[string]string`; optional): key-value annotations to the
report that provide metadata to this measurement. The consumer of this field
SHOULD NOT assume that clients using `data_format_version < 0.2.1` have always
used string values. Since `v0.2.1` clients MUST always use string values. A
client SHOULD always add to the map of annotations:

  - `engine_name` (`string`): the name of the measurement engine

  - `engine_version` (`string`): the version of the measurement engine

  - `engine_version_full` (`string`): the version of the measurement
  engine as generated by `git describe --tags`

  - `network_type` (`string`): one of:

    - mobile: when OONI Probe Mobile is using 2G/3G/4G/5G networks.

    - wifi: when OONI Probe Mobile is using Wi-Fi networks.

  - `platform` (`string`): one of:

    - android

    - ios

    - lepidopter

    - linux

    - macos

    - windows

- `backend_version` (`string`; optional): version of the backend that has
collected this specific measurement.

- `bucket_date` (`string`): a date like `"2006-01-02"` that indicates when this
measurement was processed by the data pipeline.

- `data_format_version` (`string`): indicates the data format version. The
available values are currently the following:

  - `0.1.0`: original YAML format. New code MUST NOT use that.

  - `0.2.0`: the new JSON format. OONI Probe CLI v2.x and OONI Probe
    Mobile when using Measurement Kit as the measurement engine.

  - `0.2.1`: minor revision of the JSON format. OONI Probe CLI v3.x and
    OONI Probe Mobile using `github.com/ooni/probe-engine`.

- `id` (`string`; optional): client-generated UUID4 identifying this measurement
in the context of a set of measurements (i.e. a report). Consumers of OONI data
SHOULD NOT trust this identifier to uniquely identify the measurement. This
identifier is only meaningful for measurements that have not been submitted to
a OONI collector yet. In fact, OONI collectors SHOULD clear this field to avoid
any potential confusion caused by it.

- `input` (`string`; optional): if this experiment accepts any input, the
input that was used to produce this measurement. For example, the Web
Connectivity experiment uses URLs as input.

- `input_hashes` (`[]string`; optional; deprecated): historical field that
used to contain the SHA256s of all inputs provided to the experiment. Modern
implementations, e.g. Measurement Kit, typically emit an empty list. All
clients using `v0.2.1` of the data format SHOULD NOT emit this field at all.

- `measurement_start_time` (`string`): time when this measurement was
started in UTC, using the `"2006-01-02 08:04:05"` format. Note that
ooniprobe <= 1.4.0 generates skewed time information.

- `options` (`[]string`; optional; deprecated): list of options passed on the
command line when running this specific experiment. Modern implementations,
e.g. Measurement Kit, typically emit an empty list here. All clients using
`v0.2.1` of the data format SHOULD NOT emit this field at all.

- `probe_asn` (`string`): AS Number of the probe (prefixed by AS, e.g.,
`"AS1234"`), or `"AS0"` if the user does not want to share their ASN.

- `probe_cc` (`string`): two letter country code of the probe (e.g.,
`"IT"`) or `"ZZ"` if the user does not want to share their country code.

- `probe_city` (`string`; optional; deprecated): name of the city where the
measurement was run. If the user does not want to share this information,
this field should be set to `null` by `v0.2.0` clients. Clients using `v0.2.1`
of this specification SHOULD NOT emit this field.

- `probe_ip` (`string`): IP address of the probe, or `"127.0.0.1"` if
the user does not want to share their IP.

- `report_filename` (`string`): name of the file containing the report, i.e.,
a set of related measurements, in our infrastructure. Should follow the pattern:

```
"{bucket_date}/{timestamp}-{probe_cc}-{probe_asn}-{test_name}-{report_id}-{data_format_version}-{probe|backend}.json"
```

where `{timestamp}` is like `20151122T103202Z`.

- `report_id` (`string`): identifier of a set of related measurements
generated by OONI backends when submitting one or more measurements.

- `resolver_ip` (`string`; since 0.2.1): IP of the DNS resolver used by
the probe, as determined by the measurement engine.

- `software_name` (`string`): name of the software that has generated
this specific measurement (e.g., `"ooniprobe"`).

- `software_version` (`string`): version of the software used to generate
this specific measurement (e.g., `"3.0.0"`).

- `test_helpers` (`map[string]any`): map containing information regarding
what test helpers have been used for running this measurement. Historically
we have saved into this map two different data structures:

```JSON
{"backend": "<IP>"}
```

used, e.g., by HTTP Invalid Request Line, and

```JSON
"backend": {
  "address": "https://mia-wcth.ooni.io",
  "type": "https"
}
```

used, e.g., by Web Connectivity. The former is typically used when there
can only be a single type of backend. The latter when more types are possible.

- `test_keys` (`object`): object containing specific keys that depend
upon the specific network experiment that we're running.

- `test_name` (`string`): name of the experiment in snake case. For example,
Web Connectivity SHOULD be indicated as `"web_connectivity"`.

- `test_runtime` (`float`): runtime of this specific measurement in seconds
with arbitrary sub-seconds precision. All modern implementations, i.e.
Measurement Kit and `github.com/ooni/probe-engine`, measure this value as
the time elapsed since when we start measuring a specific input (or when
we start an experiment without input) until when the measurement is
complete (i.e. all the fields inside `test_keys` have been computed or there
has been an error or timeout causing the measurement to be aborted and the
error to be recorded inside it). This specifically means that this field does
not include the time spent communicating with OONI backends such as the bouncer
and the collector, but it includes the communication with any backend that
is required to finish off the measurement (e.g. the Web Connectivity
test helper).

- `test_start_time` (`string`): like `measurement_start_time` except that it
indicates the moment in which a related set of measurements started rather than
the moment where the current measurement started. For example, for the Web
Connectivity experiment, this is the momement where we start processing a
list of input URLs.

# Example output

```JSON
{
    "annotations": {
        "engine_name": "libmeasurement_kit",
        "engine_version": "0.10.4",
        "engine_version_full": "v0.10.4",
        "network_type": "wifi",
        "platform": "ios"
    },
    "backend_version": null,
    "bucket_date": "2019-10-10",
    "data_format_version": "0.2.1",
    "id": "bc1ff44a-04e7-45e0-81a6-46bc95c7c6b0",
    "input": "http://go.com/",
    "input_hashes": [],
    "measurement_start_time": "2019-10-10 23:59:23",
    "options": [],
    "probe_asn": "AS13285",
    "probe_cc": "GB",
    "probe_city": null,
    "probe_ip": "127.0.0.1",
    "report_filename": "2019-10-10/20191010T235813Z-GB-AS13285-web_connectivity-20191010T235815Z_AS13285_SCHbEXPZ59vF8wmd6SHGGCaPxYGiEg8tSPwN85fJIFHrG4ZfVP-0.2.0-probe.json",
    "report_id": "20191010T235815Z_AS13285_SCHbEXPZ59vF8wmd6SHGGCaPxYGiEg8tSPwN85fJIFHrG4ZfVP",
    "resolver_ip": "8.8.8.8",
    "software_name": "ooniprobe-ios",
    "software_version": "2.1.0",
    "test_helpers": {
        "backend": {
            "address": "https://mia-wcth.ooni.io",
            "type": "https"
        }
    },
    "test_keys": {},	
    "test_name": "web_connectivity",
    "test_runtime": 2.2955930233,
    "test_start_time": "2019-10-10 23:58:13",
    "test_version": "0.0.1"
}
```

# Error strings

This section is non normative. Here we describe the historical mappings
between twisted errors and the corresponding ooniprobe errors:

* twisted.internet.error.ConnectionRefusedError: `connection_refused_error`

* socket.gaierror: `address_family_not_supported_error`

* twisted.internet.error.DNSLookupError: `dns_lookup_error`

* twisted.internet.error.TCPTimedOutError: `tcp_timed_out_error`

* twisted.internet.error.ConnectionDone: `connection_done`

* twisted.web._newclient.ResponseNeverReceived: `response_never_received`

* twisted.internet.error.TimeoutError: `generic_timeout_error`

* twisted.internet.error.ConnectError: `connect_error`

* twisted.internet.error.ConnectionLost: `connection_lost_error`

* twisted.internet.defer.TimeoutError: `deferred_timeout_error`

* twisted.names.error.DNSNameError: `dns_name_error`

* twisted.names.error.DNSServerError: `dns_name_failure`

* txsocksx.errors.ServerFailure: `socks_server_failure`

* txsocksx.errors.ConnectionNotAllowed: `socks_connection_not_allowed`

* txsocksx.errors.NetworkUnreachable: `socks_network_unreachable`

* txsocksx.errors.HostUnreachable: `socks_host_unreachable`

* txsocksx.errors.ConnectionRefused: `socks_connection_refused`

* txsocksx.errors.TTLExpired: `socks_ttl_expired`

* txsocksx.errors.CommandNotSupported: `socks_command_not_supported`

* txsocksx.errors.AddressNotSupported: `socks_address_not_supported`

* txsocksx.errors.SOCKSError: `socks_error`

* This will be the error message if the task has timed out: `task_timed_out`

* Every other failure: 'unknown_failure %s' % str(failure.value)

Modern implementations use different error strings that have not been
mapped for scalable processing yet.
